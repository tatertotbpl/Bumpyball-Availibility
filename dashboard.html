<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Heatmap</title>
<link rel="stylesheet" href="style.css">
<style>
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  td, th { border: 1px solid #333; padding: 5px; text-align: center; }
  td { transition: background-color 0.2s; }
  .time-cell { font-weight: bold; background-color: #eee; }
</style>
</head>
<body>
<h1 id="team-name">Team Heatmap</h1>

<table id="heatmap-grid">
  <thead>
    <tr>
      <th>Time (UTC)</th>
      <th>Mon</th>
      <th>Tue</th>
      <th>Wed</th>
      <th>Thu</th>
      <th>Fri</th>
      <th>Sat</th>
      <th>Sun</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = { /* same as before */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const teamId = urlParams.get('team') || "team1";
document.getElementById("team-name").innerText = `Team Heatmap (UTC): ${teamId}`;

const gridBody = document.querySelector('#heatmap-grid tbody');
const hours=24, days=7;
const tzOffsets = { 'UTC':0,'EST':-5,'PST':-8,'CET':1,'GMT':0,'JST':9 };

function createEmptyGrid(){ const g=[]; for(let h=0;h<hours;h++){ g[h]=[]; for(let d=0;d<days;d++) g[h][d]=0;} return g; }
function getColor(count,max){ if(!max) return '#eee'; const i=Math.round(255-(count/max)*200); return `rgb(${i},255,${i})`; }
function renderHeatmap(grid){ gridBody.innerHTML=''; let max=0; for(let h=0;h<hours;h++) for(let d=0;d<days;d++) if(grid[h][d]>max) max=grid[h][d]; for(let h=0;h<hours;h++){ const row=document.createElement('tr'); const timeCell=document.createElement('td'); timeCell.textContent=`${h}:00`; timeCell.classList.add('time-cell'); row.appendChild(timeCell); for(let d=0;d<days;d++){ const cell=document.createElement('td'); cell.textContent=grid[h][d]; cell.style.backgroundColor=getColor(grid[h][d],max); row.appendChild(cell); } gridBody.appendChild(row); }}

// convert player â†’ UTC
function convertPlayerGridToUTC(playerGrid,tz){
  const out=createEmptyGrid();
  const offset = tzOffsets[tz]??0;
  for(let h=0;h<hours;h++){
    for(let d=0;d<days;d++){
      if(!playerGrid[h][d]) continue;
      let utcHour=(h - offset + 24) % 24;
      let dayShift=(h - offset<0?-1:(h - offset>=24?1:0));
      let utcDay=(d + dayShift + 7)%7;
      out[utcHour][utcDay]=true;
    }
  }
  return out;
}

async function loadTeamHeatmap(){
  const snap = await getDoc(doc(db,'teams',teamId));
  const combined=createEmptyGrid();
  if(!snap.exists()){ renderHeatmap(combined); return; }
  const players = snap.data().players||{};
  for(const name in players){
    const grid=players[name].grid??createEmptyGrid();
    const tz=players[name].timezone??'UTC';
    const utcGrid=convertPlayerGridToUTC(grid,tz);
    for(let h=0;h<hours;h++) for(let d=0;d<days;d++) if(utcGrid[h][d]) combined[h][d]++;
  }
  renderHeatmap(combined);
}

loadTeamHeatmap();
</script>
</body>
</html>
