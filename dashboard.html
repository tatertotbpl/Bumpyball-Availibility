<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Heatmap</title>
<link rel="stylesheet" href="style.css">
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:20px}
  h1{color:#222}
  table{border-collapse:collapse;width:100%;background:#fff}
  th,td{border:1px solid #ddd;padding:6px;text-align:center;min-width:48px}
  td.time-cell{font-weight:700;background:#fafafa}
  td:hover{outline:2px solid rgba(0,0,0,.06)}
</style>
</head>
<body>

<h1 id="team-name">Team Heatmap</h1>

<table id="heatmap-grid" aria-label="team heatmap">
  <thead>
    <tr>
      <th>Time (UTC)</th>
      <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAlpvgPbox4IvXQ74uvT7wx_Zv2ARwXaYY",
  authDomain: "smashkarts-availability.firebaseapp.com",
  projectId: "smashkarts-availability",
  storageBucket: "smashkarts-availability.firebasestorage.app",
  messagingSenderId: "33863251672",
  appId: "1:33863251672:web:ffc0d728fe31321c0809ad",
  measurementId: "G-8K3MEHMLRN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const teamId = urlParams.get("team") || "team1";
document.getElementById("team-name").innerText = `Team Heatmap: ${teamId}`;

const tbody = document.querySelector("#heatmap-grid tbody");

const hours = 24;
const days = 7;

// --------------------------------------------------
// ✅ EXPANDED TIMEZONES WITH CORRECT UTC OFFSETS
// --------------------------------------------------
const tzOffsets = {
  "UTC": 0,
  "GMT": 0,
  "EST (UTC-5)": -5,
  "EDT (UTC-4)": -4,
  "CST (UTC-6)": -6,
  "CDT (UTC-5)": -5,
  "MST (UTC-7)": -7,
  "MDT (UTC-6)": -6,
  "PST (UTC-8)": -8,
  "PDT (UTC-7)": -7,
  "CET (UTC+1)": 1,
  "CEST (UTC+2)": 2,
  "JST (UTC+9)": 9,
  "AEST (UTC+10)": 10,
  "AEDT (UTC+11)": 11
};

function createEmptyCombined() {
  const g = [];
  for (let h = 0; h < hours; h++) {
    g[h] = [];
    for (let d = 0; d < days; d++) {
      g[h][d] = { total: 0, list: [] };
    }
  }
  return g;
}

function getColor(count, max) {
  if (!max) return "#fff";
  const ratio = Math.min(count / max, 1);
  const intensity = Math.round(255 - ratio * 200);
  return `rgb(${intensity},255,${intensity})`;
}

// --------------------------------------------------
// Converts a player's grid to UTC using new tz system
// --------------------------------------------------
function convertPlayerGridToUTC(playerGridObj, tzName) {
  const offset = tzOffsets[tzName] ?? 0;

  const out = [];
  for (let h = 0; h < hours; h++) {
    out[h] = [];
    for (let d = 0; d < days; d++) out[h][d] = 0;
  }

  for (let h = 0; h < hours; h++) {
    for (let d = 0; d < days; d++) {
      const val = playerGridObj?.[h]?.[d] ?? 0;
      if (!val) continue;

      const utcHour = (h - offset + 24) % 24;
      let dayShift = (h - offset < 0 ? -1 : (h - offset >= 24 ? 1 : 0));
      const utcDay = (d + dayShift + 7) % 7;

      out[utcHour][utcDay] = val;
    }
  }

  return out;
}

function renderHeatmap(combined) {
  tbody.innerHTML = "";

  let max = 0;
  for (let h = 0; h < hours; h++)
    for (let d = 0; d < days; d++)
      if (combined[h][d].total > max) max = combined[h][d].total;

  for (let h = 0; h < hours; h++) {
    const tr = document.createElement("tr");

    const tcell = document.createElement("td");
    tcell.className = "time-cell";
    tcell.textContent = `${h}:00`;
    tr.appendChild(tcell);

    for (let d = 0; d < days; d++) {
      const cell = document.createElement("td");
      const meta = combined[h][d];

      cell.style.backgroundColor = getColor(meta.total, max);
      cell.textContent = (Math.round(meta.total * 10) / 10).toString();

      cell.title = meta.list.length ? meta.list.join("\n") : "(no submissions)";
      tr.appendChild(cell);
    }

    tbody.appendChild(tr);
  }
}

async function loadTeamHeatmap() {
  const snap = await getDoc(doc(db, "teams", teamId));
  const combined = createEmptyCombined();

  if (!snap.exists()) {
    renderHeatmap(combined);
    return;
  }

  const players = snap.data().players || {};

  for (const name in players) {
    const p = players[name];
    const gridObj = p.grid || {};
    const tz = p.timezone || "UTC";

    const utcGrid = convertPlayerGridToUTC(gridObj, tz);

    for (let h = 0; h < hours; h++) {
      for (let d = 0; d < days; d++) {
        const val = utcGrid[h][d];

        if (val === 1) {
          combined[h][d].total += 0.5;
          combined[h][d].list.push(`${name} — Maybe`);
        } else if (val === 2) {
          combined[h][d].total += 1;
          combined[h][d].list.push(`${name} — Yes`);
        } else {
          combined[h][d].list.push(`${name} — No`);
        }
      }
    }
  }

  renderHeatmap(combined);
}

loadTeamHeatmap();
</script>
</body>
</html>
