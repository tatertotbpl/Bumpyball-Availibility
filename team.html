<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Availability</title>
<style>
  :root { --sidebar-w: 180px; }
  body { margin:0; padding:20px; font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; }
  main { max-width:1100px; margin:0 auto; padding-right: calc(var(--sidebar-w) + 20px); }
  h1 { margin:0 0 10px 0; color:#222; }
  
  #legend { margin:10px 0; }
  .legend-item { display:inline-block; margin:0 8px; padding:6px 10px; border-radius:6px; border:1px solid #bbb; font-weight:600; }
  .no { background:#f08080; color:#000; }
  .maybe { background:#ffd580; color:#000; }
  .yes { background:#8fbc8f; color:#000; }

  table { border-collapse:collapse; width:100%; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.06); }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; min-width:48px; cursor:pointer; }
  td.no { background:#f08080; }
  td.maybe { background:#ffd580; }
  td.yes { background:#8fbc8f; }

  .controls { display:flex; gap:8px; align-items:center; margin:10px 0; }
  .player-input input { padding:6px; }
  .player-input button { padding:6px 8px; }
  #player-list { margin-top:12px; }
  #players-ul { list-style:none; padding:0; margin:6px 0; }
  #players-ul li { margin:4px 0; }
  #players-ul button { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; text-align:left; }
  #players-ul button:hover { background:#f0f0f0; }

  #sidebar { position:fixed; right:0; top:0; width:var(--sidebar-w); height:100vh; background:#101217; color:#fff; padding:12px; box-shadow:-4px 0 12px rgba(0,0,0,.15); overflow:auto; }
  #sidebar h3 { margin:6px 0 10px 0; font-size:16px; }
  #sidebar button { display:block; width:100%; padding:8px; margin:6px 0; border:none; border-radius:6px; background:#1a1d23; color:#fff; cursor:pointer; }
  #sidebar button:hover { background:#23272f; }
  .hidden-test { opacity:.35; }

  #login-box { margin:8px 0; padding:8px; border-radius:8px; background:#fff; border:1px solid #ddd; }
  #login-box input { display:block; width:100%; padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:6px; }
  #login-box button { padding:8px 10px; margin-right:6px; }
  #login-status { font-size:13px; color:#444; margin-top:6px; }

  @media (max-width:900px) { 
    main { padding-right:12px; }
    #sidebar { display:none; }
  }
</style>
</head>
<body>

<div id="sidebar">
  <h3>Teams</h3>
  <button onclick="goTeam('Canada')">ğŸ‡¨ğŸ‡¦ Canada</button>
  <button onclick="goTeam('USA_Red')">ğŸ‡ºğŸ‡¸ USA Red</button>
  <button onclick="goTeam('USA_White')">ğŸ‡ºğŸ‡¸ USA White</button>
  <button onclick="goTeam('SUD')">ğŸ³ï¸ SUD</button>
  <button onclick="goTeam('Europe')">ğŸ‡ªğŸ‡º Europe</button>
  <button onclick="goTeam('Africa')">ğŸŒ Africa</button>
  <button onclick="goTeam('Asia')">ğŸ± Asia</button>
  <button onclick="goTeam('Geru')">ğŸ‡©ğŸ‡ªğŸ‡·ğŸ‡º Geru</button>
  <button onclick="goTeam('UK')">ğŸ‡¬ğŸ‡§ UK</button>
  <button onclick="goTeam('BraCombia')">ğŸ‡§ğŸ‡· BraCombia</button>
  <button class="hidden-test" onclick="goTeam('team1')">ğŸ”§ team1 (test)</button>
</div>

<main>
  <h1 id="team-name">Team Availability</h1>

  <div id="legend">
    <span class="legend-item no">ğŸ”´</span>
    <span class="legend-item maybe">ğŸŸ </span>
    <span class="legend-item yes">ğŸŸ¢</span>
  </div>

  <div style="margin:8px 0">
    <button id="openDashboard">ğŸ“Š Open Team Dashboard</button>
  </div>

  <div id="login-box">
    <strong style="display:block; margin-bottom:6px;">ğŸ” Sign in</strong>
    <input id="login-user" placeholder="username (no spaces)" />
    <input id="login-pass" type="password" placeholder="password" />
    <div style="margin-top:6px">
      <button id="register-btn">â• Register</button>
      <button id="login-btn">ğŸ”‘ Login</button>
      <button id="logout-btn" style="display:none">â‹ Logout</button>
    </div>
    <div id="login-status"></div>
  </div>

  <div class="controls">
    <div class="player-input">
      <label style="font-weight:600; margin-right:6px;">ğŸ‘¤</label>
      <input id="player-name" placeholder="Your name" />
      <button id="loadButton">ğŸ“¥</button>
    </div>

    <div style="margin-left:12px">
      <label style="font-weight:600">â°</label>
      <select id="timezone"></select>
    </div>

    <div style="margin-left:auto">
      <button id="saveButton">ğŸ’¾ Save</button>
    </div>
  </div>

  <div id="player-list">
    <h3 style="margin:6px 0 4px 0;">Players</h3>
    <ul id="players-ul"></ul>
  </div>

  <table id="availability-grid">
    <thead>
      <tr>
        <th>Time</th>
        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

/* ========================= FIREBASE CONFIG ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAlpvgPbox4IvXQ74uvT7wx_Zv2ARwXaYY",
  authDomain: "smashkarts-availability.firebaseapp.com",
  projectId: "smashkarts-availability",
  storageBucket: "smashkarts-availability.firebasestorage.app",
  messagingSenderId: "33863251672",
  appId: "1:33863251672:web:ffc0d728fe31321c0809ad",
  measurementId: "G-8K3MEHMLRN"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ========================= TEAM ========================= */
const allowedTeams = ["Canada","USA_Red","USA_White","SUD","Europe","Africa","Asia","Geru","UK","BraCombia","team1"];
const urlParams = new URLSearchParams(window.location.search);
const teamId = urlParams.get("team") || "team1";
if (!allowedTeams.includes(teamId)) {
  document.body.innerHTML = "<main style='max-width:700px;margin:60px auto;font-family:Arial'><h1>Team does not exist</h1></main>";
  throw new Error("Invalid team");
}
document.getElementById("team-name").innerText = `Availability: ${teamId}`;

/* ========================= DOM ELEMENTS ========================= */
const gridBody = document.querySelector("#availability-grid tbody");
const playerInput = document.getElementById("player-name");
const loadBtn = document.getElementById("loadButton");
const saveBtn = document.getElementById("saveButton");
const timezoneSelect = document.getElementById("timezone");
const playersUL = document.getElementById("players-ul");
document.getElementById("openDashboard").onclick = () => window.location.href = `dashboard.html?team=${teamId}`;

const loginUser = document.getElementById("login-user");
const loginPass = document.getElementById("login-pass");
const registerBtn = document.getElementById("register-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const loginStatus = document.getElementById("login-status");

/* ========================= TIMEZONES ========================= */
const SUPPORTED_ZONES = [
  {zone:"America/New_York", label:"EST (New York)"},
  {zone:"America/Chicago", label:"CST (Chicago)"},
  {zone:"America/Denver", label:"MST (Denver)"},
  {zone:"America/Los_Angeles", label:"PST (Los Angeles)"},
  {zone:"Europe/London", label:"GMT (London)"},
  {zone:"Europe/Berlin", label:"CET (Berlin)"},
  {zone:"Europe/Paris", label:"CET (Paris)"},
  {zone:"Africa/Johannesburg", label:"SAST (Johannesburg)"},
  {zone:"Europe/Moscow", label:"MSK (Moscow)"},
  {zone:"America/Sao_Paulo", label:"BRT (SÃ£o Paulo)"},
  {zone:"Asia/Tokyo", label:"JST (Tokyo)"},
  {zone:"Asia/Shanghai", label:"CST (Shanghai)"},
  {zone:"Asia/Almaty", label:"ALMT (Almaty)"},
  {zone:"Australia/Sydney", label:"AEST (Sydney)"}
];

function getLabelForZone(entry){
  const now = new Date();
  try {
    const fmt = new Intl.DateTimeFormat("en-US", { timeZone: entry.zone, hour12: false, timeZoneName: "shortOffset" });
    const offset = fmt.formatToParts(now).find(p=>p.type==="timeZoneName")?.value||"";
    return `${entry.label} (${offset})`;
  } catch { return entry.label; }
}

function populateTimezoneDropdown(){
  timezoneSelect.innerHTML = "";
  SUPPORTED_ZONES.forEach(entry => {
    const opt = document.createElement("option");
    opt.value = entry.zone;
    opt.textContent = getLabelForZone(entry);
    timezoneSelect.appendChild(opt);
  });
}
populateTimezoneDropdown();

/* ========================= GRID LOGIC ========================= */
const hours = 24, days = 7;
let gridData = [];

function createEmptyGrid(){ return Array.from({length:hours},()=>Array(days).fill(0)); }
function getClass(v){ return v===0?"no":v===1?"maybe":"yes"; }

function populateGrid(data){
  gridBody.innerHTML = "";
  gridData = data;
  for(let h=0;h<hours;h++){
    const row = document.createElement("tr");
    const timeCell = document.createElement("td");
    timeCell.textContent = `${h}:00`;
    timeCell.style.fontWeight="600";
    row.appendChild(timeCell);
    for(let d=0;d<days;d++){
      const cell = document.createElement("td");
      cell.className = getClass(gridData[h][d]);
      cell.onclick = () => { gridData[h][d]=(gridData[h][d]+1)%3; cell.className=getClass(gridData[h][d]); }
      row.appendChild(cell);
    }
    gridBody.appendChild(row);
  }
}

/* ========================= FIRESTORE HELPERS ========================= */
const playerRef = (uid) => doc(db, "teams", teamId, "players", uid);
function gridToFS(grid){ return grid.reduce((acc,h,i)=>{ acc[i]={}; h.forEach((v,d)=>acc[i][d]=v); return acc; },{}); }
function fsToGrid(obj){ const g=createEmptyGrid(); for(let h=0;h<hours;h++) for(let d=0;d<days;d++) g[h][d]=obj?.[h]?.[d]??0; return g; }

/* ========================= LOAD / SAVE PLAYER ========================= */
async function loadPlayer(uid){
  if(!uid) return alert("Enter name");

  const snap = await getDoc(playerRef(uid));
  if(snap.exists()) {
    const data = snap.data();
    populateGrid(fsToGrid(data.grid));
    if(data.timezone) timezoneSelect.value = data.timezone;
  } else {
    populateGrid(createEmptyGrid());
  }

  loadPlayerList(); // still lists all players
}

async function savePlayer(name){
  if(!name) return alert("Enter name");
  if(!auth.currentUser) return alert("Log in first");

  const uid = auth.currentUser.uid;

  // Save only to this player's doc
  await setDoc(playerRef(uid), {
    grid: gridToFS(gridData),
    timezone: timezoneSelect.value,
    displayName: name
  });

  alert("Saved!");
  loadPlayerList();
}

/* ========================= PLAYER LIST ========================= */
import { collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

async function loadPlayerList(){
  const playersCol = collection(db, "teams", teamId, "players");
  const snap = await getDocs(playersCol);
  playersUL.innerHTML = "";
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const li = document.createElement("li");
    const btn = document.createElement("button");
    btn.textContent = data.displayName || docSnap.id;
    btn.onclick = () => {
      playerInput.value = data.displayName || docSnap.id;
      populateGrid(fsToGrid(data.grid));
      if(data.timezone) timezoneSelect.value = data.timezone;
    };
    li.appendChild(btn);
    playersUL.appendChild(li);
  });
}

/* ========================= AUTH ========================= */
registerBtn.onclick = async ()=>{
  const u = loginUser.value.trim(), p = loginPass.value;
  if(!u||!p) return alert("Enter username & password");
  try{ await createUserWithEmailAndPassword(auth,`${u}@bumpyball.local`,p); loginStatus.textContent="Registered & signed in"; }
  catch(e){ alert(e.message); }
};

loginBtn.onclick = async ()=>{
  const u = loginUser.value.trim(), p = loginPass.value;
  if(!u||!p) return alert("Enter username & password");
  try{ await signInWithEmailAndPassword(auth,`${u}@bumpyball.local`,p); loginStatus.textContent="Signed in"; }
  catch(e){ alert(e.message); }
};

logoutBtn.onclick = ()=>signOut(auth);

onAuthStateChanged(auth,user=>{
  if(user){
    const short=user.email.replace(/@.*$/,"");
    loginStatus.textContent=`Signed in as ${short}`;
    logoutBtn.style.display="inline-block";
    loginBtn.style.display="none";
    registerBtn.style.display="none";
    loginUser.value=short;
    playerInput.value=short;
    playerInput.disabled=false;
  } else {
    loginStatus.textContent="Not signed in";
    logoutBtn.style.display="none";
    loginBtn.style.display="inline-block";
    registerBtn.style.display="inline-block";
    playerInput.disabled=false;
  }
});

/* ========================= BUTTON HOOKS ========================= */
loadBtn.onclick = ()=>loadPlayer(auth.currentUser?.uid);
saveBtn.onclick = ()=>savePlayer(playerInput.value.trim());

/* ========================= NAVIGATION ========================= */
window.goTeam = id=>{
  if(!allowedTeams.includes(id)) return alert("Team does not exist");
  window.location.href=`team.html?team=${id}`;
}

/* ========================= INIT ========================= */
populateGrid(createEmptyGrid());
loadPlayerList();
</script>
</body>
</html>
