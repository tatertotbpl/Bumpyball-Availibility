<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Availability</title>
<link rel="stylesheet" href="style.css">
<style>
  table { border-collapse: collapse; width: 100%; }
  td, th { border: 1px solid #333; padding: 5px; text-align: center; }
  .available { background-color: #6f6; }
  .unavailable { background-color: #f66; }
  input, button, select { margin: 5px 0; }
  #player-list { margin-top: 20px; padding: 10px; border: 1px solid #aaa; width: 200px; }
  #player-list ul { list-style: none; padding-left: 0; }
  #player-list li { padding: 4px; border-bottom: 1px solid #ccc; cursor: pointer; }
  #player-list li:hover { background: #eee; }
</style>
</head>
<body>
<h1 id="team-name">Team Availability</h1>

<button onclick="window.location.href='dashboard.html?team=' + teamId">
  Open Team Dashboard
</button>

<div class="player-input">
  <label for="player-name">Player Name:</label>
  <input type="text" id="player-name" placeholder="Your Name">
  <button id="loadButton">Load Grid</button>
</div>

<div id="player-list">
  <h3>Players</h3>
  <ul id="players-ul"></ul>
</div>

<div class="timezone-selector">
  <label for="timezone">Select your timezone:</label>
  <select id="timezone">
    <option value="UTC">UTC</option>
    <option value="EST">EST</option>
    <option value="PST">PST</option>
    <option value="CET">CET</option>
    <option value="GMT">GMT</option>
    <option value="JST">JST</option>
  </select>
</div>

<table id="availability-grid">
  <thead>
    <tr>
      <th>Time</th>
      <th>Mon</th>
      <th>Tue</th>
      <th>Wed</th>
      <th>Thu</th>
      <th>Fri</th>
      <th>Sat</th>
      <th>Sun</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="saveButton">Save Availability</button>

<!-- keep all your current HTML/CSS, just update the script part -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAlpvgPbox4IvXQ74uvT7wx_Zv2ARwXaYY",
  authDomain: "smashkarts-availability.firebaseapp.com",
  projectId: "smashkarts-availability",
  storageBucket: "smashkarts-availability.firebasestorage.app",
  messagingSenderId: "33863251672",
  appId: "1:33863251672:web:ffc0d728fe31321c0809ad",
  measurementId: "G-8K3MEHMLRN"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const teamId = urlParams.get('team') || "team1";
window.teamId = teamId;
document.getElementById("team-name").innerText = `Availability: ${teamId}`;

const gridBody = document.querySelector('#availability-grid tbody');
const playerInput = document.getElementById('player-name');
const loadButton = document.getElementById('loadButton');
const saveButton = document.getElementById('saveButton');
const timezoneSelect = document.getElementById('timezone');

const hours = 24, days = 7;
let gridDataUTC = []; // store grid always in UTC
let currentPlayerName = null;

// timezone offsets in hours
const tzOffsets = { 'UTC':0,'EST':-5,'PST':-8,'CET':1,'GMT':0,'JST':9 };

// --- helpers ---
function createEmptyGrid() {
  const g = [];
  for(let h=0;h<hours;h++){ g[h]=[]; for(let d=0;d<days;d++) g[h][d]=false; }
  return g;
}

// convert grid from UTC → local tz for display
function convertGridFromUTC(grid, tz) {
  const offset = tzOffsets[tz] ?? 0;
  const out = createEmptyGrid();
  for(let h=0;h<hours;h++){
    for(let d=0;d<days;d++){
      if(grid[h][d]){
        let localHour = (h + offset + 24) % 24;
        let dayShift = Math.floor((h + offset) / 24);
        let localDay = (d + dayShift + 7) % 7;
        out[localHour][localDay] = true;
      }
    }
  }
  return out;
}

// convert grid from local tz → UTC for saving
function convertGridToUTC(grid, tz){
  const offset = tzOffsets[tz] ?? 0;
  const out = createEmptyGrid();
  for(let h=0;h<hours;h++){
    for(let d=0;d<days;d++){
      if(grid[h][d]){
        let utcHour = (h - offset + 24) % 24;
        let dayShift = (h - offset < 0 ? -1 : h - offset >= 24 ? 1 : 0);
        let utcDay = (d + dayShift + 7) % 7;
        out[utcHour][utcDay] = true;
      }
    }
  }
  return out;
}

// populate table in local tz
function populateGrid(data){
  gridBody.innerHTML='';
  for(let h=0;h<hours;h++){
    const row = document.createElement('tr');
    const timeCell = document.createElement('td'); 
    timeCell.textContent=`${h}:00`; 
    row.appendChild(timeCell);

    for(let d=0;d<days;d++){
      const val = data?.[h]?.[d] || false;
      const cell = document.createElement('td');
      cell.classList.add(val?'available':'unavailable');
      cell.addEventListener('click',()=>{
        const tz = timezoneSelect.value;
        const displayGrid = convertGridFromUTC(gridDataUTC, tz);
        displayGrid[h][d] = !displayGrid[h][d];
        gridDataUTC = convertGridToUTC(displayGrid, tz);
        updateGridDisplay();
      });
      row.appendChild(cell);
    }
    gridBody.appendChild(row);
  }
}

// refresh table display in current timezone without touching UTC data
function updateGridDisplay() {
  const tz = timezoneSelect.value;
  const displayGrid = convertGridFromUTC(gridDataUTC, tz);
  populateGrid(displayGrid);
}

// Firestore helpers
function gridToFirestore(grid){ return grid; }
function firestoreToGrid(obj){ return obj; }

// load player
async function loadPlayerData(name){
  if(!name) return alert("Enter your name!");
  currentPlayerName = name;
  const snap = await getDoc(doc(db,'teams',teamId));
  if(!snap.exists()) await setDoc(doc(db,'teams',teamId),{players:{}});
  const stored = snap.exists()? snap.data().players?.[name]: null;
  if(stored){
    const tz = stored.timezone || 'UTC';
    timezoneSelect.value = tz;
    gridDataUTC = stored.grid;
    updateGridDisplay();
  } else {
    gridDataUTC = createEmptyGrid();
    updateGridDisplay();
  }
  await loadPlayerList();
}

// save player
async function savePlayerData(name){
  if(!name) return alert("Enter your name!");
  const tz = timezoneSelect.value;
  await setDoc(doc(db,'teams',teamId),{
    players: {[name]: {grid:gridDataUTC, timezone:tz}}
  }, {merge:true});
  alert("Saved!");
  await loadPlayerList();
}

// load player list
async function loadPlayerList(){
  const snap = await getDoc(doc(db,'teams',teamId));
  if(!snap.exists()) return;
  const players = snap.data().players || {};
  const list = document.getElementById("players-ul");
  list.innerHTML='';
  Object.keys(players).forEach(player=>{
    const li = document.createElement('li');
    li.textContent = player;
    li.addEventListener('click',()=>{
      playerInput.value = player;
      currentPlayerName = player;
      const tz = players[player].timezone || 'UTC';
      timezoneSelect.value = tz;
      gridDataUTC = players[player].grid;
      updateGridDisplay();
    });
    list.appendChild(li);
  });
}

// events
loadButton.addEventListener('click',()=>loadPlayerData(playerInput.value.trim()));
saveButton.addEventListener('click',()=>savePlayerData(playerInput.value.trim()));
timezoneSelect.addEventListener('change', ()=>updateGridDisplay());

// init
gridDataUTC = createEmptyGrid();
updateGridDisplay();
loadPlayerList();
</script>
</body>
</html>
