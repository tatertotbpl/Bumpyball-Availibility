<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Availability</title>
<link rel="stylesheet" href="style.css">
<style>
  :root{--sidebar-w:180px}
  body{margin:0;padding:20px;font-family:Arial,helvetica,sans-serif;background:#f3f4f6}
  main{max-width:1100px;margin:0 auto;padding-right:calc(var(--sidebar-w) + 20px)}
  h1{margin:0 0 10px 0;color:#222}
  /* legend + grid */
  #legend{margin:10px 0}
  .legend-item{display:inline-block;margin:0 8px;padding:6px 10px;border-radius:6px;border:1px solid #bbb;font-weight:600}
  .no{background:#f08080;color:#000}
  .maybe{background:#ffd580;color:#000}
  .yes{background:#8fbc8f;color:#000}
  /* grid */
  table{border-collapse:collapse;width:100%;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
  th,td{border:1px solid #ddd;padding:6px;text-align:center;min-width:48px;cursor:pointer}
  td.no{background:#f08080}
  td.maybe{background:#ffd580}
  td.yes{background:#8fbc8f}
  /* small UI */
  .controls{display:flex;gap:8px;align-items:center;margin:10px 0}
  .player-input input{padding:6px}
  .player-input button{padding:6px 8px}
  #player-list{margin-top:12px}
  #players-ul{list-style:none;padding:0;margin:6px 0}
  #players-ul li{margin:4px 0}
  #players-ul button{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;text-align:left}
  #players-ul button:hover{background:#f0f0f0}
  /* sidebar */
  #sidebar{position:fixed;right:0;top:0;width:var(--sidebar-w);height:100vh;background:#101217;color:#fff;padding:12px;box-shadow:-4px 0 12px rgba(0,0,0,.15);overflow:auto}
  #sidebar h3{margin:6px 0 10px 0;font-size:16px}
  #sidebar button{display:block;width:100%;padding:8px;margin:6px 0;border:none;border-radius:6px;background:#1a1d23;color:#fff;cursor:pointer}
  #sidebar button:hover{background:#23272f}
  .hidden-test{opacity:.35}
  /* login box */
  #login-box{margin:8px 0;padding:8px;border-radius:8px;background:#fff;border:1px solid #ddd}
  #login-box input{display:block;width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:6px}
  #login-box button{padding:8px 10px;margin-right:6px}
  #login-status{font-size:13px;color:#444;margin-top:6px}
  /* responsive */
  @media (max-width:900px){ main{padding-right:12px} #sidebar{display:none}}
</style>
</head>
<body>
<div id="sidebar" aria-hidden="false">
  <h3>Teams</h3>
  <button onclick="goTeam('Canada')">ğŸ‡¨ğŸ‡¦ Canada</button>
  <button onclick="goTeam('USA_Red')">ğŸ‡ºğŸ‡¸ USA Red</button>
  <button onclick="goTeam('USA_White')">ğŸ‡ºğŸ‡¸ USA White</button>
  <button onclick="goTeam('SUD')">ğŸ³ï¸ SUD</button>
  <button onclick="goTeam('Europe')">ğŸŒ Europe</button>
  <button onclick="goTeam('Africa')">ğŸŒ Africa</button>
  <button onclick="goTeam('Asia')">ğŸŒ Asia</button>
  <button onclick="goTeam('Geru')">ğŸŒ Geru</button>
  <button onclick="goTeam('UK')">ğŸ‡¬ğŸ‡§ UK</button>
  <button class="hidden-test" onclick="goTeam('team1')">ğŸ”§ team1 (test)</button>
</div>

<main>
  <h1 id="team-name">Team Availability</h1>

  <!-- legend -->
  <div id="legend">
    <span class="legend-item no">ğŸ”´</span>
    <span class="legend-item maybe">ğŸŸ </span>
    <span class="legend-item yes">ğŸŸ¢</span>
  </div>

  <!-- dashboard button -->
  <div style="margin:8px 0">
    <button id="openDashboard">ğŸ“Š Open Team Dashboard</button>
  </div>

  <!-- login box -->
  <div id="login-box" aria-live="polite">
    <strong style="display:block;margin-bottom:6px">ğŸ” Sign in</strong>
    <input id="login-user" placeholder="username (no spaces)" />
    <input id="login-pass" type="password" placeholder="password" />
    <div style="margin-top:6px">
      <button id="register-btn">â• Register</button>
      <button id="login-btn">ğŸ”‘ Login</button>
      <button id="logout-btn" style="display:none">â‹ Logout</button>
    </div>
    <div id="login-status"></div>
  </div>

  <!-- controls -->
  <div class="controls">
    <div class="player-input">
      <label style="font-weight:600;margin-right:6px">ğŸ‘¤</label>
      <input id="player-name" placeholder="Your name" />
      <button id="loadButton">ğŸ“¥</button>
    </div>

    <div style="margin-left:12px">
      <label style="font-weight:600">â°</label>
      <select id="timezone">
        <option value="UTC">UTC</option>
        <option value="EST">EST</option>
        <option value="PST">PST</option>
        <option value="CET">CET</option>
        <option value="GMT">GMT</option>
        <option value="JST">JST</option>
      </select>
    </div>

    <div style="margin-left:auto">
      <button id="saveButton">ğŸ’¾ Save</button>
    </div>
  </div>

  <!-- players list -->
  <div id="player-list">
    <h3 style="margin:6px 0 4px 0">Players</h3>
    <ul id="players-ul"></ul>
  </div>

  <!-- availability grid -->
  <table id="availability-grid" aria-label="availability grid">
    <thead>
      <tr>
        <th>Time</th>
        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script type="module">
/* ======= FIREBASE + AUTH SETUP ======= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAlpvgPbox4IvXQ74uvT7wx_Zv2ARwXaYY",
  authDomain: "smashkarts-availability.firebaseapp.com",
  projectId: "smashkarts-availability",
  storageBucket: "smashkarts-availability.firebasestorage.app",
  messagingSenderId: "33863251672",
  appId: "1:33863251672:web:ffc0d728fe31321c0809ad",
  measurementId: "G-8K3MEHMLRN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ======= PAGE SETUP & WHITELIST ======= */
const allowedTeams = ["Canada","USA_Red","USA_White","SUD","Europe","Africa","Asia","Geru","UK","team1"];
const urlParams = new URLSearchParams(window.location.search);
const teamId = urlParams.get('team') || "team1";
if (!allowedTeams.includes(teamId)) {
  document.body.innerHTML = `<main style="max-width:700px;margin:60px auto;font-family:Arial,sans-serif"><h1>Team does not exist.</h1><p>This team id is not allowed.</p></main>`;
  throw new Error("Not allowed team");
}
window.teamId = teamId;
document.getElementById('team-name').innerText = `Availability: ${teamId}`;

/* ======= DOM refs ======= */
const gridBody = document.querySelector('#availability-grid tbody');
const playerInput = document.getElementById('player-name');
const loadButton = document.getElementById('loadButton');
const saveButton = document.getElementById('saveButton');
const timezoneSelect = document.getElementById('timezone');
const playersUL = document.getElementById('players-ul');
const openDashboardBtn = document.getElementById('openDashboard');

const loginUser = document.getElementById('login-user');
const loginPass = document.getElementById('login-pass'); // may be undefined if user didn't include id; handle later
const registerBtn = document.getElementById('register-btn');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loginStatus = document.getElementById('login-status');

openDashboardBtn.onclick = ()=> window.location.href = `dashboard.html?team=${teamId}`;

/* ======= GRID MODEL ======= */
const hours = 24;
const days = 7;
let gridData = []; // numeric grid for currently displayed (0/1/2)
function createEmptyGrid(){
  const g = [];
  for(let h=0;h<hours;h++){ g[h]=[]; for(let d=0;d<days;d++) g[h][d]=0; }
  return g;
}

/* ======= TIMEZONE OFFSETS (simple fixed offsets) ======= */
const tzOffsets = { 'UTC':0,'EST':-5,'PST':-8,'CET':1,'GMT':0,'JST':9 };

/* ======= UI HELPERS ======= */
function getClassForValue(v){ return v===0?'no':v===1?'maybe':'yes'; }

function populateGrid(data){
  gridBody.innerHTML = '';
  for (let h=0; h<hours; h++){
    const row = document.createElement('tr');
    const tcell = document.createElement('td'); tcell.textContent = `${h}:00`; tcell.style.fontWeight='600';
    row.appendChild(tcell);
    gridData[h] = gridData[h] || [];
    for (let d=0; d<days; d++){
      const val = data?.[h]?.[d] ?? 0;
      const cell = document.createElement('td');
      gridData[h][d] = val;
      cell.className = getClassForValue(val);
      // click cycles 0->1->2->0 and saves in gridData
      cell.addEventListener('click', ()=>{
        gridData[h][d] = (gridData[h][d] + 1) % 3;
        cell.className = getClassForValue(gridData[h][d]);
      });
      row.appendChild(cell);
    }
    gridBody.appendChild(row);
  }
}

/* ======= FIRESTORE CONVERSION (store as objects to avoid nested arrays issues) ======= */
function gridToFirestoreObject(grid){
  const out = {};
  for(let h=0;h<hours;h++){ out[h] = {}; for(let d=0;d<days;d++) out[h][d] = grid[h][d] ?? 0; }
  return out;
}
function firestoreObjectToGrid(obj){
  const g = createEmptyGrid();
  for(let h=0;h<hours;h++) for(let d=0;d<days;d++) g[h][d] = obj?.[h]?.[d] ?? 0;
  return g;
}

/* ======= FIRESTORE DOC REF ======= */
const teamRef = (id)=> doc(db, 'teams', id);

/* ======= LOAD / SAVE PLAYER ======= */
async function loadPlayerData(name){
  if(!name) return alert('enter a name');
  const snap = await getDoc(teamRef(teamId));
  if(!snap.exists()) await setDoc(teamRef(teamId), { players: {} });
  const players = snap.exists() ? snap.data().players || {} : {};
  const stored = players[name] || null;
  if(stored){
    populateGrid(firestoreObjectToGrid(stored.grid));
    if(stored.timezone) timezoneSelect.value = stored.timezone;
  } else populateGrid(createEmptyGrid());
  await loadPlayerList();
}

async function savePlayerData(name){
  if(!name) return alert('enter a name');
  // require login
  const user = auth.currentUser;
  if(!user){ return alert('you must be logged in to save (register/login above)'); }
  // ensure username matches logged in user
  const short = user.email.replace(/@.*$/,'');
  if(short !== name){
    return alert(`save blocked: logged in as "${short}". Set player name to that, or log in as that user.`);
  }

  // convert gridData -> firestore object
  const firestoreGrid = gridToFirestoreObject(gridData);
  const tz = timezoneSelect.value || 'UTC';
  await setDoc(teamRef(teamId), { players: { [name]: { grid: firestoreGrid, timezone: tz } } }, { merge:true });
  alert('Saved!');
  await loadPlayerList();
}

/* ======= PLAYER LIST ======= */
async function loadPlayerList(){
  const snap = await getDoc(teamRef(teamId));
  if(!snap.exists()) return;
  const players = snap.data().players || {};
  playersUL.innerHTML = '';
  Object.keys(players).forEach(p=>{
    const li = document.createElement('li');
    const btn = document.createElement('button');
    btn.textContent = p;
    btn.addEventListener('click', ()=>{
      playerInput.value = p;
      populateGrid(firestoreObjectToGrid(players[p].grid));
      if(players[p].timezone) timezoneSelect.value = players[p].timezone;
    });
    li.appendChild(btn);
    playersUL.appendChild(li);
  });
}

/* ======= AUTH UI ======= */
registerBtn.addEventListener('click', async ()=>{
  const u = document.getElementById('login-user').value?.trim();
  const p = document.getElementById('login-pass').value ?? document.getElementById('login-pass')?.value;
  if(!u || !p) return alert('fill username and password');
  // create email like username@bumpy.local (no sending needed)
  try{
    await createUserWithEmailAndPassword(auth, `${u}@bumpyball.local`, p);
    loginStatus.textContent = 'Registered and signed in';
  }catch(e){ alert(e.message) }
});

loginBtn.addEventListener('click', async ()=>{
  const u = document.getElementById('login-user').value?.trim();
  const p = document.getElementById('login-pass').value ?? document.getElementById('login-pass')?.value;
  if(!u || !p) return alert('fill username and password');
  try{
    await signInWithEmailAndPassword(auth, `${u}@bumpyball.local`, p);
    loginStatus.textContent = 'Signed in';
  }catch(e){ alert(e.message) }
});

logoutBtn.addEventListener('click', async ()=> { await signOut(auth); });

onAuthStateChanged(auth, user=>{
  if(user){
    const short = user.email.replace(/@.*$/,'');
    loginStatus.textContent = `Signed in as ${short}`;
    logoutBtn.style.display = 'inline-block';
    loginBtn.style.display = 'none';
    registerBtn.style.display = 'none';
    document.getElementById('login-user').value = short;
    playerInput.value = short;
    playerInput.disabled = true;
  } else {
    loginStatus.textContent = 'Not signed in';
    logoutBtn.style.display = 'none';
    loginBtn.style.display = 'inline-block';
    registerBtn.style.display = 'inline-block';
    playerInput.disabled = false;
  }
});

/* ======= BUTTON HOOKUPS ======= */
loadButton.addEventListener('click', ()=> loadPlayerData(playerInput.value.trim()));
saveButton.addEventListener('click', ()=> savePlayerData(playerInput.value.trim()));

/* ======= NAVIGATION / SIDEBAR HELPERS ======= */
function goTeam(id){
  if(!allowedTeams.includes(id)){ alert('Team does not exist'); return; }
  window.location.href = `team.html?team=${id}`;
}
window.goTeam = goTeam; // allow inline onclick from HTML

/* ======= INIT ======= */
populateGrid(createEmptyGrid());
loadPlayerList();

</script>
</body>
</html>
