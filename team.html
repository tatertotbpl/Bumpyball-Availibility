<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Availability</title>
<link rel="stylesheet" href="style.css">
<style>
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  td, th { border: 1px solid #333; padding: 5px; text-align: center; cursor: pointer; }
  #legend { margin: 10px auto; }
  .legend-item { display: inline-block; margin: 0 10px; padding: 5px 10px; border: 1px solid #999; border-radius: 4px; }
  .no { background-color: #f08080; }      /* red = no */
  .maybe { background-color: #ffd580; }   /* orange = maybe */
  .yes { background-color: #8fbc8f; }     /* green = yes */
</style>
</head>
<body>
<h1 id="team-name">Team Availability</h1>

<!-- Legend -->
<div id="legend">
  <span class="legend-item no">No</span>
  <span class="legend-item maybe">Maybe</span>
  <span class="legend-item yes">Yes</span>
</div>

<button onclick="window.location.href='dashboard.html?team=' + teamId">
  Open Team Dashboard
</button>

<div class="player-input">
  <label for="player-name">Player Name:</label>
  <input type="text" id="player-name" placeholder="Your Name">
  <button id="loadButton">Load Grid</button>
</div>

<div id="player-list">
  <h3>Players</h3>
  <ul id="players-ul"></ul>
</div>

<div class="timezone-selector">
  <label for="timezone">Select your timezone:</label>
  <select id="timezone">
    <option value="UTC">UTC</option>
    <option value="EST">EST</option>
    <option value="PST">PST</option>
    <option value="CET">CET</option>
    <option value="GMT">GMT</option>
    <option value="JST">JST</option>
  </select>
</div>

<table id="availability-grid">
  <thead>
    <tr>
      <th>Time</th>
      <th>Mon</th>
      <th>Tue</th>
      <th>Wed</th>
      <th>Thu</th>
      <th>Fri</th>
      <th>Sat</th>
      <th>Sun</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="saveButton">Save Availability</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// --- Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyAlpvgPbox4IvXQ74uvT7wx_Zv2ARwXaYY",
  authDomain: "smashkarts-availability.firebaseapp.com",
  projectId: "smashkarts-availability",
  storageBucket: "smashkarts-availability.firebasestorage.app",
  messagingSenderId: "33863251672",
  appId: "1:33863251672:web:ffc0d728fe31321c0809ad",
  measurementId: "G-8K3MEHMLRN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Page setup ---
const urlParams = new URLSearchParams(window.location.search);
const teamId = urlParams.get('team') || "team1";
window.teamId = teamId;
document.getElementById("team-name").innerText = `Availability: ${teamId}`;

const gridBody = document.querySelector('#availability-grid tbody');
const playerInput = document.getElementById('player-name');
const loadButton = document.getElementById('loadButton');
const saveButton = document.getElementById('saveButton');
const timezoneSelect = document.getElementById('timezone');

const hours = 24;
const days = 7;
let gridData = [];

// --- Grid helpers ---
function createEmptyGrid() {
  const grid = [];
  for (let h = 0; h < hours; h++) {
    grid[h] = [];
    for (let d = 0; d < days; d++) grid[h][d] = 0; // 0 = No
  }
  return grid;
}

function getClassForValue(val) {
  if (val === 0) return 'no';
  if (val === 1) return 'maybe';
  if (val === 2) return 'yes';
}

// Populate grid
function populateGrid(data) {
  gridBody.innerHTML = '';
  for (let h = 0; h < hours; h++) {
    const row = document.createElement('tr');
    const timeCell = document.createElement('td');
    timeCell.textContent = `${h}:00`;
    row.appendChild(timeCell);

    gridData[h] = gridData[h] || [];

    for (let d = 0; d < days; d++) {
      const val = data?.[h]?.[d] ?? 0;
      const cell = document.createElement('td');
      cell.className = getClassForValue(val);

      // Cycle on click: 0 → 1 → 2 → 0
      cell.addEventListener('click', () => {
        gridData[h][d] = (gridData[h][d] + 1) % 3;
        cell.className = getClassForValue(gridData[h][d]);
      });

      gridData[h][d] = val;
      row.appendChild(cell);
    }

    gridBody.appendChild(row);
  }
}

// --- Firestore helpers ---
function gridToFirestore(grid) {
  const out = {};
  for (let h = 0; h < hours; h++) {
    out[h] = {};
    for (let d = 0; d < days; d++) out[h][d] = grid[h][d];
  }
  return out;
}

function firestoreToGrid(obj) {
  const grid = [];
  for (let h = 0; h < hours; h++) {
    grid[h] = [];
    for (let d = 0; d < days; d++) grid[h][d] = obj?.[h]?.[d] ?? 0;
  }
  return grid;
}

// --- Load Player Data ---
async function loadPlayerData(name) {
  if (!name) return alert("Enter your name!");

  const snap = await getDoc(doc(db, 'teams', teamId));
  if (!snap.exists()) await setDoc(doc(db, 'teams', teamId), { players: {} });

  const stored = snap.exists() ? snap.data().players?.[name] : null;

  if (stored) {
    populateGrid(firestoreToGrid(stored.grid));
    if (stored.timezone) timezoneSelect.value = stored.timezone;
  } else {
    populateGrid(createEmptyGrid()); // start all cells as No
  }

  await loadPlayerList();
}

// --- Save Player Data ---
async function savePlayerData(name) {
  if (!name) return alert("Enter your name!");
  const tz = timezoneSelect.value;
  const firestoreGrid = gridToFirestore(gridData);

  await setDoc(doc(db, 'teams', teamId), {
    players: { [name]: { grid: firestoreGrid, timezone: tz } }
  }, { merge: true });

  alert("Saved!");
  await loadPlayerList();
}

// --- Player List ---
async function loadPlayerList() {
  const snap = await getDoc(doc(db, 'teams', teamId));
  if (!snap.exists()) return;
  const players = snap.data().players || {};
  const list = document.getElementById("players-ul");
  list.innerHTML = "";

  Object.keys(players).forEach(player => {
    const li = document.createElement("li");
    li.textContent = player;

    li.addEventListener("click", () => {
      playerInput.value = player;
      populateGrid(firestoreToGrid(players[player].grid));
      if (players[player].timezone) timezoneSelect.value = players[player].timezone;
    });

    list.appendChild(li);
  });
}

// --- Button events ---
loadButton.addEventListener('click', () => loadPlayerData(playerInput.value.trim()));
saveButton.addEventListener('click', () => savePlayerData(playerInput.value.trim()));

// --- Init ---
populateGrid(createEmptyGrid());
loadPlayerList();
</script>
</body>
</html>
