<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Availability</title>
  <link rel="stylesheet" href="style.css">
  <style>
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #333; padding: 5px; text-align: center; }
    .available { background-color: #6f6; }
    .unavailable { background-color: #f66; }
    input, button, select { margin: 5px 0; }
    #player-list { margin-top: 20px; padding: 10px; border: 1px solid #aaa; width: 200px; }
    #player-list ul { list-style: none; padding-left: 0; }
    #player-list li { padding: 4px; border-bottom: 1px solid #ccc; cursor: pointer; }
    #player-list li:hover { background: #eee; }
  </style>
</head>
<body>
  <h1 id="team-name">Team Availability</h1>

  <button onclick="window.location.href='dashboard.html?team=' + teamId">
    Open Team Dashboard
  </button>

  <div class="player-input">
    <label for="player-name">Player Name:</label>
    <input type="text" id="player-name" placeholder="Your Name">
    <button id="loadButton">Load Grid</button>
  </div>

  <div id="player-list">
    <h3>Players</h3>
    <ul id="players-ul"></ul>
  </div>

  <div class="timezone-selector">
    <label for="timezone">Select your timezone:</label>
    <select id="timezone">
      <option value="UTC">UTC</option>
      <option value="America/New_York">EST</option>
      <option value="America/Los_Angeles">PST</option>
      <option value="Europe/London">GMT</option>
      <option value="Europe/Berlin">CET</option>
      <option value="Asia/Tokyo">JST</option>
    </select>
  </div>

  <table id="availability-grid">
    <thead>
      <tr>
        <th>Time</th>
        <th>Mon</th>
        <th>Tue</th>
        <th>Wed</th>
        <th>Thu</th>
        <th>Fri</th>
        <th>Sat</th>
        <th>Sun</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="saveButton">Save Availability</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// ---- Firebase ----
const firebaseConfig = {
  apiKey: "AIzaSyAlpvgPbox4IvXQ74uvT7wx_Zv2ARwXaYY",
  authDomain: "smashkarts-availability.firebaseapp.com",
  projectId: "smashkarts-availability",
  storageBucket: "smashkarts-availability.firebasestorage.app",
  messagingSenderId: "33863251672",
  appId: "1:33863251672:web:ffc0d728fe31321c0809ad",
  measurementId: "G-8K3MEHMLRN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---- Page setup ----
const urlParams = new URLSearchParams(window.location.search);
window.teamId = urlParams.get('team') || "team1"; // needed globally
document.getElementById("team-name").innerText = `Availability: ${teamId}`;

const gridBody = document.querySelector('#availability-grid tbody');
const playerInput = document.getElementById('player-name');
const loadButton = document.getElementById('loadButton');
const saveButton = document.getElementById('saveButton');

const startHour = 0;
const endHour = 23;
let gridData = [];

const teamRef = doc(db, 'teams', teamId);

const heatmapButton = document.getElementById('viewHeatmap');

heatmapButton.addEventListener('click', () => {
  // Open the dashboard.html with the same teamId
  window.location.href = `dashboard.html?team=${teamId}`;
});

// ---- Grid Renderer ----
function populateGrid(data) {
  gridBody.innerHTML = '';

  for (let hour = startHour; hour <= endHour; hour++) {
    const row = document.createElement('tr');
    const timeCell = document.createElement('td');
    timeCell.textContent = `${hour}:00`;
    row.appendChild(timeCell);

    gridData[hour] = gridData[hour] || [];

    for (let day = 0; day < 7; day++) {
      const val = data?.[hour]?.[day] || false;
      const cell = document.createElement('td');
      cell.classList.add(val ? 'available' : 'unavailable');

      cell.addEventListener('click', () => {
        const now = !gridData[hour][day];
        gridData[hour][day] = now;
        cell.classList.toggle('available');
        cell.classList.toggle('unavailable');
      });

      gridData[hour][day] = val;
      row.appendChild(cell);
    }

    gridBody.appendChild(row);
  }
}

// ---- Firestore conversion helpers ----
function gridToFirestoreObject(grid) {
  const out = {};
  for (let h = 0; h < 24; h++) {
    out[h] = {};
    for (let d = 0; d < 7; d++) out[h][d] = !!grid[h][d];
  }
  return out;
}

function firestoreObjectToGrid(obj) {
  const grid = [];
  for (let h = 0; h < 24; h++) {
    grid[h] = [];
    for (let d = 0; d < 7; d++) grid[h][d] = obj?.[h]?.[d] || false;
  }
  return grid;
}

// ---- Load Player Data ----
async function loadPlayerData(name) {
  if (!name) return alert("Enter your name!");

  const snap = await getDoc(teamRef);
  const stored = snap.exists() ? snap.data().players?.[name] : null;

  populateGrid(firestoreObjectToGrid(stored));
  await loadPlayerList();
}

// ---- Save Player Data ----
async function savePlayerData(name) {
  if (!name) return alert("Enter your name!");

  const firestoreGrid = gridToFirestoreObject(gridData);

  await setDoc(
    teamRef,
    { players: { [name]: firestoreGrid } },
    { merge: true }
  );

  alert("Saved!");
  await loadPlayerList();
}

// ---- Player List Loader ----
async function loadPlayerList() {
  const snap = await getDoc(teamRef);
  if (!snap.exists()) return;

  const players = snap.data().players || {};
  const list = document.getElementById("players-ul");
  list.innerHTML = "";

  Object.keys(players).forEach(player => {
    const li = document.createElement("li");
    li.textContent = player;

    li.addEventListener("click", () => {
      playerInput.value = player;
      populateGrid(firestoreObjectToGrid(players[player]));
    });

    list.appendChild(li);
  });
}

// ---- Button Events ----
loadButton.addEventListener('click', () =>
  loadPlayerData(playerInput.value.trim())
);

saveButton.addEventListener('click', () =>
  savePlayerData(playerInput.value.trim())
);

// ---- Init ----
populateGrid([]);
loadPlayerList();

</script>
</body>
</html>
