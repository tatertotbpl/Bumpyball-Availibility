<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Availability</title>
<style>
  :root { --sidebar-w: 180px; }
  body { margin:0; padding:20px; font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; }
  main { max-width:1100px; margin:0 auto; padding-right: calc(var(--sidebar-w) + 20px); }
  h1 { margin:0 0 10px 0; color:#222; }
  
  /* legend */
  #legend { margin:10px 0; }
  .legend-item { display:inline-block; margin:0 8px; padding:6px 10px; border-radius:6px; border:1px solid #bbb; font-weight:600; }
  .no { background:#f08080; color:#000; }
  .maybe { background:#ffd580; color:#000; }
  .yes { background:#8fbc8f; color:#000; }

  /* table */
  table { border-collapse:collapse; width:100%; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.06); }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; min-width:48px; cursor:pointer; }
  td.no { background:#f08080; }
  td.maybe { background:#ffd580; }
  td.yes { background:#8fbc8f; }

  /* small UI */
  .controls { display:flex; gap:8px; align-items:center; margin:10px 0; }
  .player-input input { padding:6px; }
  .player-input button { padding:6px 8px; }
  #player-list { margin-top:12px; }
  #players-ul { list-style:none; padding:0; margin:6px 0; }
  #players-ul li { margin:4px 0; }
  #players-ul button { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; text-align:left; }
  #players-ul button:hover { background:#f0f0f0; }

  /* sidebar */
  #sidebar { position:fixed; right:0; top:0; width:var(--sidebar-w); height:100vh; background:#101217; color:#fff; padding:12px; box-shadow:-4px 0 12px rgba(0,0,0,.15); overflow:auto; }
  #sidebar h3 { margin:6px 0 10px 0; font-size:16px; }
  #sidebar button { display:block; width:100%; padding:8px; margin:6px 0; border:none; border-radius:6px; background:#1a1d23; color:#fff; cursor:pointer; }
  #sidebar button:hover { background:#23272f; }
  .hidden-test { opacity:.35; }

  /* login box */
  #login-box { margin:8px 0; padding:8px; border-radius:8px; background:#fff; border:1px solid #ddd; }
  #login-box input { display:block; width:100%; padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:6px; }
  #login-box button { padding:8px 10px; margin-right:6px; }
  #login-status { font-size:13px; color:#444; margin-top:6px; }

  /* responsive */
  @media (max-width:900px) { main { padding-right:12px; } #sidebar { display:none; } }
</style>
</head>
<body>

<div id="sidebar">
  <h3>Teams</h3>
  <button onclick="goTeam('Canada')">ğŸ‡¨ğŸ‡¦ Canada</button>
  <button onclick="goTeam('USA_Red')">ğŸ‡ºğŸ‡¸ USA Red</button>
  <button onclick="goTeam('USA_White')">ğŸ‡ºğŸ‡¸ USA White</button>
  <button onclick="goTeam('SUD')">ğŸ³ï¸ SUD</button>
  <button onclick="goTeam('Europe')">ğŸŒ Europe</button>
  <button onclick="goTeam('Africa')">ğŸŒ Africa</button>
  <button onclick="goTeam('Asia')">ğŸŒ Asia</button>
  <button onclick="goTeam('Geru')">ğŸŒ Geru</button>
  <button onclick="goTeam('UK')">ğŸ‡¬ğŸ‡§ UK</button>
  <button class="hidden-test" onclick="goTeam('team1')">ğŸ”§ team1 (test)</button>
</div>

<main>
  <h1 id="team-name">Team Availability</h1>

  <div id="legend">
    <span class="legend-item no">ğŸ”´</span>
    <span class="legend-item maybe">ğŸŸ </span>
    <span class="legend-item yes">ğŸŸ¢</span>
  </div>

  <div style="margin:8px 0">
    <button id="openDashboard">ğŸ“Š Open Team Dashboard</button>
  </div>

  <div id="login-box">
    <strong style="display:block; margin-bottom:6px;">ğŸ” Sign in</strong>
    <input id="login-user" placeholder="username (no spaces)" />
    <input id="login-pass" type="password" placeholder="password" />
    <div style="margin-top:6px">
      <button id="register-btn">â• Register</button>
      <button id="login-btn">ğŸ”‘ Login</button>
      <button id="logout-btn" style="display:none">â‹ Logout</button>
    </div>
    <div id="login-status"></div>
  </div>

  <div class="controls">
    <div class="player-input">
      <label style="font-weight:600; margin-right:6px;">ğŸ‘¤</label>
      <input id="player-name" placeholder="Your name" />
      <button id="loadButton">ğŸ“¥</button>
    </div>

    <div style="margin-left:12px">
      <label style="font-weight:600">â°</label>
      <select id="timezone">
        <option value="UTC">UTC</option>
        <option value="EST">EST</option>
        <option value="PST">PST</option>
        <option value="CET">CET</option>
        <option value="GMT">GMT</option>
        <option value="JST">JST</option>
      </select>
    </div>

    <div style="margin-left:auto">
      <button id="saveButton">ğŸ’¾ Save</button>
    </div>
  </div>

  <div id="player-list">
    <h3 style="margin:6px 0 4px 0;">Players</h3>
    <ul id="players-ul"></ul>
  </div>

  <table id="availability-grid">
    <thead>
      <tr>
        <th>Time</th>
        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script type="module">
// ========================= FIREBASE & AUTH =========================
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAlpvgPbox4IvXQ74uvT7wx_Zv2ARwXaYY",
  authDomain: "smashkarts-availability.firebaseapp.com",
  projectId: "smashkarts-availability",
  storageBucket: "smashkarts-availability.firebasestorage.app",
  messagingSenderId: "33863251672",
  appId: "1:33863251672:web:ffc0d728fe31321c0809ad",
  measurementId: "G-8K3MEHMLRN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ========================= TEAM =========================
const allowedTeams = ["Canada","USA_Red","USA_White","SUD","Europe","Africa","Asia","Geru","UK","team1"];
const urlParams = new URLSearchParams(window.location.search);
const teamId = urlParams.get("team") || "team1";
if (!allowedTeams.includes(teamId)) {
  document.body.innerHTML = "<main style='max-width:700px;margin:60px auto;font-family:Arial'><h1>Team does not exist</h1></main>";
  throw new Error("Invalid team");
}
document.getElementById("team-name").innerText = `Availability: ${teamId}`;

// ========================= DOM =========================
const gridBody = document.querySelector("#availability-grid tbody");
const playerInput = document.getElementById("player-name");
const loadBtn = document.getElementById("loadButton");
const saveBtn = document.getElementById("saveButton");
const timezoneSelect = document.getElementById("timezone");
const playersUL = document.getElementById("players-ul");
document.getElementById("openDashboard").onclick = () => { window.location.href = `dashboard.html?team=${teamId}`; };

const loginUser = document.getElementById("login-user");
const loginPass = document.getElementById("login-pass");
const registerBtn = document.getElementById("register-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const loginStatus = document.getElementById("login-status");

// ========================= GRID =========================
const hours = 24;
const days = 7;
let gridData = [];

function createEmptyGrid() {
  const g = [];
  for (let h=0; h<hours; h++) { g[h]=[]; for(let d=0; d<days; d++) g[h][d]=0; }
  return g;
}

function getClass(v) { return v===0?"no":v===1?"maybe":"yes"; }

function populateGrid(data){
  gridBody.innerHTML = "";
  gridData = data;
  for(let h=0; h<hours; h++){
    const row = document.createElement("tr");
    const timeCell = document.createElement("td");
    timeCell.textContent = `${h}:00`;
    timeCell.style.fontWeight = "600";
    row.appendChild(timeCell);
    for(let d=0; d<days; d++){
      const cell = document.createElement("td");
      cell.className = getClass(gridData[h][d]);
      cell.onclick = () => { gridData[h][d] = (gridData[h][d]+1)%3; cell.className=getClass(gridData[h][d]); }
      row.appendChild(cell);
    }
    gridBody.appendChild(row);
  }
}

// ========================= FIRESTORE CONVERSION =========================
function gridToFS(grid){ const out={}; for(let h=0;h<hours;h++){ out[h]={}; for(let d=0;d<days;d++) out[h][d]=grid[h][d]; } return out; }
function fsToGrid(obj){ const g=createEmptyGrid(); for(let h=0;h<hours;h++) for(let d=0;d<days;d++) g[h][d]=obj?.[h]?.[d]??0; return g; }
const teamRef = ()=>doc(db,"teams",teamId);

// ========================= LOAD / SAVE PLAYER =========================
async function loadPlayer(name){
  if(!name) return alert("enter name");
  const snap = await getDoc(teamRef());
  if(!snap.exists()) await setDoc(teamRef(),{players:{}});
  const players = snap.data()?.players||{};
  const stored = players[name];
  if(stored){ populateGrid(fsToGrid(stored.grid)); if(stored.timezone) timezoneSelect.value=stored.timezone; } 
  else populateGrid(createEmptyGrid());
  loadPlayerList();
}

async function savePlayer(name){
  if(!name) return alert("enter name");
  if(!auth.currentUser) return alert("log in first");
  const expected = auth.currentUser.email.replace(/@.*$/,"");
  if(name!==expected) return alert(`Player name must match your login: "${expected}"`);
  await setDoc(teamRef(),{players:{[name]:{grid:gridToFS(gridData),timezone:timezoneSelect.value}}},{merge:true});
  alert("Saved!");
  loadPlayerList();
}

// ========================= PLAYER LIST =========================
async function loadPlayerList(){
  const snap = await getDoc(teamRef());
  if(!snap.exists()) return;
  const players = snap.data()?.players||{};
  playersUL.innerHTML = "";
  Object.keys(players).forEach(name=>{
    const li=document.createElement("li");
    const btn=document.createElement("button");
    btn.textContent=name;
    btn.onclick=()=>{ playerInput.value=name; populateGrid(fsToGrid(players[name].grid)); if(players[name].timezone) timezoneSelect.value=players[name].timezone; };
    li.appendChild(btn); playersUL.appendChild(li);
  });
}

// ========================= AUTH =========================
registerBtn.onclick = async ()=>{
  const u = loginUser.value.trim(); const p = loginPass.value;
  if(!u||!p) return alert("Enter username & password");
  try{ await createUserWithEmailAndPassword(auth,`${u}@bumpyball.local`,p); loginStatus.textContent="Registered & signed in"; } 
  catch(e){ alert(e.message); }
};

loginBtn.onclick = async ()=>{
  const u = loginUser.value.trim(); const p = loginPass.value;
  if(!u||!p) return alert("Enter username & password");
  try{ await signInWithEmailAndPassword(auth,`${u}@bumpyball.local`,p); loginStatus.textContent="Signed in"; } 
  catch(e){ alert(e.message); }
};

logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,user=>{
  if(user){
    const short=user.email.replace(/@.*$/,"");
    loginStatus.textContent=`Signed in as ${short}`;
    logoutBtn.style.display="inline-block"; loginBtn.style.display="none"; registerBtn.style.display="none";
    loginUser.value=short; playerInput.value=short; playerInput.disabled=true;
  } else {
    loginStatus.textContent="Not signed in"; logoutBtn.style.display="none"; loginBtn.style.display="inline-block"; registerBtn.style.display="inline-block"; playerInput.disabled=false;
  }
});

// ========================= BUTTON HOOKS =========================
loadBtn.onclick=()=>loadPlayer(playerInput.value.trim());
saveBtn.onclick=()=>savePlayer(playerInput.value.trim());

// ========================= NAV =========================
window.goTeam = id=>{ if(!allowedTeams.includes(id)) return alert("Team does not exist"); window.location.href=`team.html?team=${id}`; }

// ========================= INIT =========================
populateGrid(createEmptyGrid());
loadPlayerList();
</script>
</body>
</html>
